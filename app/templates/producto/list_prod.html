{% extends 'app/base.html' %}
{% block contenido %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Lista de Productos</h1>
        <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProdModal">Agregar Producto</a>

        <!-- Modal para agregar producto -->
        <div class="modal fade" id="addProdModal" tabindex="-1" aria-labelledby="addProdModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addProdModalLabel">Agregar Producto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Aquí se cargará el formulario mediante AJAX -->
                        <div id="modal-body-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Botón para abrir el modal de operaciones de bodega -->
    <a href="#" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#operacionesBodegaModal">Operaciones de Bodega</a>

    <!-- Modal para operaciones de bodega -->
    <div class="modal fade" id="operacionesBodegaModal" tabindex="-1" aria-labelledby="operacionesBodegaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="operacionesBodegaModalLabel">Operaciones de Bodega</h5>
                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-body-content-bodega">
                    <!-- El formulario se cargará aquí mediante AJAX -->
                </div>
            </div>
        </div>
    </div>


    <div class="mb-4">
        <form method="get" class="d-flex align-items-center">
            <label for="estado" class="me-2">Filtrar por estado:</label>
            <select name="estado" id="estado" class="form-select w-auto me-3" onchange="this.form.submit();">
                <option value="">Todos</option>
                <option value="disponible" {% if estado_filtro == 'disponible' %}selected{% endif %}>Disponible</option>
                <option value="sin_stock" {% if estado_filtro == 'sin_stock' %}selected{% endif %}>Sin Stock</option>
                <option value="registrado_reciente" {% if estado_filtro == 'registrado_reciente' %}selected{% endif %}>Nuevo</option>
            </select>

            <label for="categoria" class="me-2">Filtrar por categoría:</label>
            <select name="categoria" id="categoria" class="form-select w-auto me-3" onchange="this.form.submit();">
                <option value="">Todas</option>
                {% for categoria in categorias %}
                    <option value="{{ categoria.id }}" {% if categoria_filtro == categoria.id %}selected{% endif %}>
                        {{ categoria.nombre }}
                    </option>
                {% endfor %}
            </select>
            

            {% if request.user.is_superuser %}
            <label for="negocio" class="me-2">Filtrar por negocio:</label>
            <select name="negocio" id="negocio" class="form-select w-auto" onchange="this.form.submit();">
                <option value="">Todos los negocios</option>
                {% for negocio in negocios %}
                    <option value="{{ negocio.id }}" {% if negocio_filtro == negocio.id %}selected{% endif %}>
                        {{ negocio.nombre }}
                    </option>
                {% endfor %}
            </select>
            {% endif %}
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Marca</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Precio Mayorista</th>
                    <th>Descuento</th>
                    <th>Descuento Mayorista</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos %}
                    <tr class="{% if producto.estado == 'sin_stock' or producto.estado == 'ingresado_manual' %}table-danger{% elif producto.estado == 'registrado_reciente' %}table-warning{% else %}table-success{% endif %}">
                        <td>{{ producto.producto_id }}</td>
                        <td>{{ producto.nombre }}</td>
                        <td>{{ producto.marca }}</td>
                        <td>{{ producto.categoria }}</td>
                        <td>{{ producto.precio }}</td>
                        <td>{{ producto.precio_mayorista }}</td>
                        <td>{{ producto.descuento }}</td>
                        <td>{{ producto.descuento_mayorista }}</td>
                        <td>
                            {% if producto.stock > 0 %}
                                {{ producto.stock }}
                            {% else %}
                                <span class="text-danger">Sin Stock</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if producto.estado == 'disponible' %}
                                <span class="badge bg-success">Disponible</span>
                            {% elif producto.estado == 'sin_stock' %}
                                <span class="badge bg-danger">Sin Stock</span>
                            {% elif producto.estado == 'registrado_reciente' %}
                                <span class="badge bg-warning">Nuevo</span>
                            {% elif producto.estado == 'ingresado_manual' %}
                                <span class="badge bg-danger">Ingresado Manual</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="#" class="btn btn-primary btn-sm edit-product" data-bs-toggle="modal" data-bs-target="#modProdModal{{ producto.producto_id }}" data-product-id="{{ producto.producto_id }}">Editar</a>

                            <!-- Modal para editar producto -->
                            <div class="modal fade" id="modProdModal{{ producto.producto_id }}" tabindex="-1" aria-labelledby="modProdModalLabel{{ producto.producto_id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="modProdModalLabel{{ producto.producto_id }}">Editar Producto - {{ producto.nombre }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body" id="modal-body-content-{{ producto.producto_id }}">
                                            <!-- El formulario se cargará aquí mediante AJAX -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>            
        </table>
    </div>
    {% if not productos %}
        <div class="alert alert-warning text-center mt-4">No hay productos disponibles.</div>
    {% endif %}
</div>

<!-- Incluye jQuery antes de tus scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Script para manejar modales y cargar formularios -->
<script>
    function bindOperacionesBodegaForm() {
        $('#operaciones-bodega-form').on('submit', function (e) {
            e.preventDefault();

            const ajaxUrl = "{% url 'operaciones_bodega_modal' %}";
            console.log("AJAX URL:", ajaxUrl);

            $.ajax({
                url: ajaxUrl,
                type: "POST",
                data: $(this).serialize(),
                success: function (data) {
                    if (data.success) {
                        $('#operacionesBodegaModal').modal('hide');
                        location.reload();
                    } else {
                        $('#modal-body-content-bodega').html(data.html_form);
                        bindOperacionesBodegaForm(); // Re-vincular el manejador si el formulario se re-renderiza
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error en la solicitud AJAX:", status, error);
                }
            });
        });
    }

    $(document).ready(function () {
        // Cargar el formulario de Operaciones de Bodega cuando se abra el modal
        $('#operacionesBodegaModal').on('show.bs.modal', function () {
            $.get("{% url 'operaciones_bodega_modal' %}", function (data) {
                $('#modal-body-content-bodega').html(data.html_form);
                bindOperacionesBodegaForm(); // Vincular el manejador después de cargar el formulario
            });
        });

        // Cargar el formulario de Agregar Producto cuando se abra el modal
        $('#addProdModal').on('show.bs.modal', function () {
            console.log("Cargando formulario en modal...");
            $.get("{% url 'add_prod_modal' %}", function (data) {
                $('#modal-body-content').html(data.html_form);
                // No es necesario vincular el formulario aquí; se maneja en el template cargado
            });
        });

        // Manejar la carga del formulario de edición de producto
        $('a.edit-product').on('click', function () {
            let productId = $(this).data('product-id');

            $.get("{% url 'mod_prod_modal' 0 %}".replace('0', productId), function (data) {
                $('#modal-body-content-' + productId).html(data.html_form);
                // El manejador de envío se incluye en el template cargado
            });
        });
    });
</script>

{% endblock %}
