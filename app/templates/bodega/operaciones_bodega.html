{% extends 'app/base.html' %}
{% load custom_filters %}

{% block contenido %}
<div class="container mt-4">
        {% if request.user.is_superuser %}
        <form method="get" class="mb-3">
            <label for="negocio" class="me-2">Filtrar por negocio:</label>
            <select name="negocio" id="negocio" class="form-select w-auto" onchange="this.form.submit();">
                <option value="">Todos los negocios</option>
                {% for negocio in negocios %}
                    <option value="{{ negocio.id }}" {% if negocio_filtro == negocio.id %}selected{% endif %}>
                        {{ negocio.nombre }}
                    </option>
                {% endfor %}
            </select>
        </form>
        {% endif %}
    
    <h1 class="text-center">Operaciones de Bodega</h1>
    {% if not request.user.is_superuser %}
    <div class="form-wrapper">
        <h2>Registrar Entrada de Productos</h2>
            <form method="post" id="entradaBodegaForm">
                {% csrf_token %}

                <!-- Fecha de recepción -->
                <div class="mb-3">
                    <label for="fecha_recepcion" class="form-label">Fecha de Recepción</label>
                    <input type="date" class="form-control" id="fecha_recepcion" name="fecha_recepcion" required>
                </div>

                <!-- Formulario de EntradaBodega -->
                {{ entrada_form.as_p }}
                {{ producto_formset.management_form }}

                    <div id="productos-container">
                        {% for form in producto_formset %}
                            <div class="producto-form">
                                {{ form.as_p }}
                                <button type="button" class="btn btn-danger" onclick="this.closest('.producto-form').remove()">Eliminar Producto</button>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="agregarProducto()">Agregar Otro Producto</button>
                    <button type="submit" class="btn btn-primary">Registrar Entrada</button>
                </form>
        </div>
    {% endif %}

    <script>
        function agregarProducto() {
            const container = document.getElementById('productos-container');
            const totalForms = document.getElementById('id_form-TOTAL_FORMS');
            const formIdx = container.querySelectorAll('.producto-form').length;
    
            const newForm = container.querySelector('.producto-form').cloneNode(true);
            newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIdx);
            
            newForm.querySelectorAll('input, select, textarea').forEach(input => {
                const name = input.getAttribute('name').replace(/-\d+-/, `-${formIdx}-`);
                const id = input.getAttribute('id').replace(/-\d+-/, `-${formIdx}-`);
                input.setAttribute('name', name);
                input.setAttribute('id', id);
                input.value = '';  // Limpia el valor de los campos en el nuevo formulario
            });
    
            container.appendChild(newForm);
            totalForms.value = parseInt(totalForms.value) + 1;  // Incrementa el contador total de formularios
        }
    </script>
    
    
{% endblock %}
